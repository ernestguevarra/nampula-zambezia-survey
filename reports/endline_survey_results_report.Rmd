---
title: "Improving nutrition status for under 5 children in Zambezia and Nampula"
subtitle: "Endline survey results"
author: 
    - name: Mark Myatt
    - name: Ernest Guevarra
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: true
    toc_depth: 3
    self_contained: true
    code_download: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  warning = FALSE,
  error = FALSE,
  message = FALSE,
  echo = FALSE
)

suppressPackageStartupMessages(source("packages.R"))
for (f in list.files(here::here("R"), full.names = TRUE)) source (f)

targets::tar_load(dplyr::starts_with("endline"))
targets::tar_load(overall_results_all)

water_ladder <- c("#4575b4", "#74add1", "#ffffbf", "#feb24c", "#ec7014")
sanitation_ladder <- c("#1a9850", "#a6d96a", "#ffffbf", "#feb24c", "#ec7014")
hygiene_ladder <- c("#cab2d6", "#feb24c", "#ec7014")
bmi_classes <- c("#d7191c", "#fdae61", "#abdda4", "#2b83ba")
unicef_blue <- "#1CABE2"

theme_mozambique <- theme_bw() + 
  theme(
    plot.title = element_text(size = 14),
    plot.subtitle = element_text(size = 12),
    panel.border = element_rect(size = 0.5, colour = "gray70"),
    panel.grid.major = element_line(
      linetype = 1, size = 0.2, colour = "gray90"
    ),
    panel.grid.minor = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size = 12, hjust = 0),
    legend.key = element_rect(linetype = 0),
    axis.line.x = element_line(size = 1, colour = "gray70"),
    axis.text.x = element_text(size = 10),
    axis.text.y = element_text(size = 10),
    axis.ticks = element_line(colour = "gray70", size = 0.5)
  )
```

<style type="text/css">
  body{
  font-size: 12pt;
}
</style>

<br/>

## Demographics - respondent

### By province and overall

```{r demo_respondent, echo = FALSE}
endline_demo_respondent_table_report |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Sex" = 2, "Age (years)" = 1, "Age group" = 9, "Language" = 7, 
      "Civil staus" = 7, "Number of years of formal education" = 1, 
      "Number of years of formal education (grouped)" = 4, "Occupation" = 8
    )
  )
```

### By study group and overall

```{r demo_respondent_study_group, echo = FALSE}
endline_demo_respondent_study_group_table_report |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Sex" = 2, "Age (years)" = 1, "Age group" = 9, "Language" = 7, 
      "Civil staus" = 7, "Number of years of formal education" = 1, 
      "Number of years of formal education (grouped)" = 4, "Occupation" = 8
    )
  )
```

<br/>

## Demographics - child

### By province and overall

```{r demo_child, echo = FALSE}
endline_demo_child_table_report |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Sex" = 2, "Age (months)" = 1, "Age group" = 7, 
      "Current breastfeeding status" = 1, "Carer's age at birth" = 10, 
      "Location of birth" = 3, "Mode of delivery" = 1, 
      "Presence of complications" = 1, "Birth weight" = 1
    )
  )
```

### By study group and overall

```{r demo_child_study_group, echo = FALSE}
endline_demo_child_study_group_table_report |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Sex" = 2, "Age (months)" = 1, "Age group" = 7, 
      "Current breastfeeding status" = 1, "Carer's age at birth" = 10, 
      "Location of birth" = 3, "Mode of delivery" = 1, 
      "Presence of complications" = 1, "Birth weight" = 1
    )
  )
```

<br/>

## Demographics - spouse

### By province and overall

```{r demo_spouse, echo = FALSE}
endline_demo_spouse_table_report |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Age (years)" = 1, "Age group" = 13, 
      "Number of years of formal education" = 1, 
      "Number of years of formal education (grouped)" = 4, 
      "Occupation" = 9, "Lives at home" = 4
    )
  )
```

### By study group and overall

```{r demo_spouse_study_group, echo = FALSE}
endline_demo_spouse_study_group_table_report |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Age (years)" = 1, "Age group" = 13, 
      "Number of years of formal education" = 1, 
      "Number of years of formal education (grouped)" = 4, 
      "Occupation" = 9, "Lives at home" = 4
    )
  )
```

<br/>

## Household income

### By province and overall

```{r hh_income, echo = FALSE}
rbind(
  endline_hh_income_table_report,
  endline_hh_income1_table_report
) |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Number of persons living in household" = 1, 
      "Number of under 5 years children living in household" = 1, 
      "Number of pregnant women living in household" = 1, 
      "Monthly household income" = 11, 
      "Source of household income" = 9, 
      "Sufficiency of household income" = 4,
      "Sufficiency of family resource" = 4,
      "Household income against household expenses" = 4
    )
  )
```

### By study group and overall

```{r hh_income_study_group, echo = FALSE}
rbind(
  endline_hh_income_study_group_table_report,
  endline_hh_income1_study_group_table_report
) |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Number of persons living in household" = 1, 
      "Number of under 5 years children living in household" = 1, 
      "Number of pregnant women living in household" = 1, 
      "Monthly household income" = 11, 
      "Source of household income" = 9, 
      "Sufficiency of household income" = 4,
      "Sufficiency of family resource" = 4,
      "Household income against household expenses" = 4
    )
  )
```

<br/>

## Household structure

### By province and overall

```{r hh_structure, echo = FALSE}
endline_hh_structure_table_report |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Home ownership" = 3, 
      "Number of rooms in home" = 14, 
      "Number of bedrooms in home" = 10, 
      "Roofing material" = 11, 
      "Flooring material" = 11, 
      "Number of months living in current location" = 1,
      "Number of months living in current location (grouped)" = 14
    )
  )
```

### By study group and overall

```{r hh_structure_study_group, echo = FALSE}
endline_hh_structure_study_group_table_report |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Home ownership" = 3, 
      "Number of rooms in home" = 14, 
      "Number of bedrooms in home" = 10, 
      "Roofing material" = 11, 
      "Flooring material" = 11, 
      "Number of months living in current location" = 1,
      "Number of months living in current location (grouped)" = 14
    )
  )
```

<br/>

## Household amenities

### By province and overall

```{r hh_amenities, echo = FALSE}
endline_hh_amenities_table_report |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  (\(x)
    {
      rbind(
        x[1:3, ],
        x[1, ] |>
          (\(x) { x[1, ] <- c("Landline", rep(NA_character_, 9)); x })()
      ) |>
        rbind(
          x[4:nrow(x), ]
        ) |>
        (\(x) { x[9, 1] <- "Refrigerator - alternative"; x } )()
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Communication and information access" = 6, 
      "Amenities" = 3, 
      "Number of mosquito nets owned" = 5, 
      "Fuel used for cooking" = 8, 
      "Location of food preparation" = 4, 
      "Fuel used for lighting" = 6
    )
  )
```

### By study group and overall

```{r hh_amenities_study_group, echo = FALSE}
endline_hh_amenities_study_group_table_report |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  (\(x)
    {
      rbind(
        x[1:3, ],
        x[1, ] |>
          (\(x) { x[1, ] <- c("Landline", rep(NA_character_, 9)); x })()
      ) |>
        rbind(
          x[4:nrow(x), ]
        ) |>
        (\(x) { x[9, 1] <- "Refrigerator - alternative"; x } )()
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Communication and information access" = 6, 
      "Amenities" = 3, 
      "Number of mosquito nets owned" = 5, 
      "Fuel used for cooking" = 8, 
      "Location of food preparation" = 4, 
      "Fuel used for lighting" = 6
    )
  )
```

<br/>

## Mode of daily travel

### By province and overall

```{r hh_travel, echo = FALSE}
rbind(
  endline_hh_travel_province_table_report,
  endline_hh_travel1_province_table_report
) |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Usual mode of travel" = 9,
      "Time to travel to health centre (minutes)" = 1,
      "Mode of travel to health centre" = 7, 
      "Time to travel to local markets (minutes)" = 1, 
      "Mode of travel to local markets" = 7, 
      "Time to travel to primary school (minutes)" = 1, 
      "Mode of travel to primary school" = 7,
      "Time to travel to secondary school (minutes)" = 1, 
      "Mode of travel to secondary school" = 7
    )
  )
```

### By study group and overall

```{r hh_travel_study_group, echo = FALSE}
rbind(
  endline_hh_travel_study_group_table_report,
  endline_hh_travel1_study_group_table_report
) |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Usual mode of travel" = 9,
      "Time to travel to health centre (minutes)" = 1,
      "Mode of travel to health centre" = 7, 
      "Time to travel to local markets (minutes)" = 1, 
      "Mode of travel to local markets" = 7, 
      "Time to travel to primary school (minutes)" = 1, 
      "Mode of travel to primary school" = 7,
      "Time to travel to secondary school (minutes)" = 1, 
      "Mode of travel to secondary school" = 7
    )
  )
```

<br/>

## Household decision making

### By province and overall

```{r hh_decision, echo = FALSE}
endline_hh_decision_province_table_report |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Marrying age" = 5,
      "Using condoms" = 5,
      "Household responsibilities" = 5, 
      "Family planning" = 5, 
      "Agricultural tasks" = 5, 
      "Household finances" = 5, 
      "Child rearing" = 5,
      "Child discipline" = 5, 
      "Healthcare in pregnancy" = 5,
      "Healthcare for child" = 5
    )
  )
```

### By study group and overall

```{r hh_decision_study_group, echo = FALSE}
endline_hh_decision_study_group_table_report |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Marrying age" = 5,
      "Using condoms" = 5,
      "Household responsibilities" = 5, 
      "Family planning" = 5, 
      "Agricultural tasks" = 5, 
      "Household finances" = 5, 
      "Child rearing" = 5,
      "Child discipline" = 5, 
      "Healthcare in pregnancy" = 5,
      "Healthcare for child" = 5
    )
  )
```

<br/>

## Child anthropometry

```{r child_anthro_province_plot, fig.align = "center", fig.width = 10, fig.height = 8}
overall_results_all |>
  subset(
    indicator_set_code == "child_anthro" & study_round == "Endline" &
      strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_variable != "severe_wasting_by_oedema" &
      stringr::str_detect(
        string = indicator_variable, pattern = "global", negate = TRUE
      ) &
      indicator_category != "Mean"
  ) |>
  dplyr::mutate(
    strata = factor(strata, levels = c("Zambézia", "Nampula", "Overall")),
    malnutrition_class = ifelse(
      stringr::str_detect(
        string = indicator_variable, pattern = "moderate"
      ), "Moderate", "Severe"
    ),
    indicator_label = factor(
      indicator_label,
      label = c("Stunting", "Underweight", "Wasting (MUAC)", "Wasting (WHZ)")
    )
  ) |>
  ggplot(
    mapping = aes(
      x = study_group, y = estimate * 100, fill = malnutrition_class
    )
  ) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "", values = alpha(c("#FFEA00", "#a50026"), 0.6)) +
  labs(
    title = "Prevalence of child undernutrition",
    subtitle = "Proportion of children 6-59 months old who are stunting, underweight, and wasting",
    x = "", y = "%"
  ) +
  facet_grid(
    rows = vars(indicator_label), cols = vars(strata), scales = "free_y"
  ) +
  theme_mozambique
```

### Child Stunting

```{r child_stunting, echo = FALSE}
child_stunting_province_overall <- endline_child_anthro_province_table |>
  subset(
    indicator_variable %in% c(
      "hfaz", "global_stunting", "moderate_stunting", "severe_stunting"
    ),
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )()

child_stunting_strata <- endline_child_anthro_strata_table |>
  subset(
    indicator_variable %in% c(
      "hfaz", "global_stunting", "moderate_stunting", "severe_stunting"
    ) &
      strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

child_stunting_study_group <- endline_child_anthro_study_group_table |>
  subset(
    indicator_variable %in% c(
      "hfaz", "global_stunting", "moderate_stunting", "severe_stunting"
    ) &
      study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  child_stunting_province_overall,
  child_stunting_strata,
  child_stunting_study_group
) |>
  (\(x) x[ , c(1, 2, 6, 10, 3, 7, 11, 4, 8, 12, 5, 9, 13)])() |>
  (\(x)
    {
      x[ , 2:4]  <- round(x[ , 2:4], digits = 3)
      x[ , 5:13] <- round(x[ , 5:13] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 4)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Mean Height-for-Age z-score" = 3, 
      "Global Stunting" = 3, 
      "Moderate Stunting" = 3, 
      "Severe Stunting" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

```{r child_stunting_strata_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_anthro" & study_round == "Endline" &
      !strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_variable != "severe_wasting_by_oedema" &
      indicator_label == "Child stunting" &
      stringr::str_detect(
        string = indicator_variable, pattern = "global", negate = TRUE
      ) &
      indicator_category != "Mean"
  ) |>
  dplyr::mutate(
    province = ifelse(
      strata %in% c("Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"),
      "Nampula", "Zambézia"
    ) |>
      factor(levels = c("Zambézia", "Nampula")),
    strata = factor(
      strata,
      levels = c(
        "Gurúè", "Lugela", "Pebane", "Molumbo", "Rest of Zambézia", 
        "Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"
      ),
      labels = c(
        "\nGurúè", "\nLugela", "\nPebane", "\nMolumbo", "Rest of\nZambézia", 
        "\nMonapo", "\nNacala-A-Velha", "\nRibáuè", "Rest of\nNampula"
      )
    ),
    malnutrition_class = ifelse(
      stringr::str_detect(
        string = indicator_variable, pattern = "moderate"
      ), "Moderate", "Severe"
    )
  ) |>
  ggplot(
    mapping = aes(
      x = strata, y = estimate * 100, fill = malnutrition_class
    )
  ) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "", values = alpha(c("#FFEA00", "#a50026"), 0.6)) +
  scale_y_continuous(
    limits = c(0, 70), breaks = seq(from = 0, to = 70, by = 10)
  ) +
  labs(
    title = "Prevalence of child stunting",
    subtitle = "Proportion of children 6-59 months old who are stunting by district of Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~province, ncol = 2, scales = "free_x") +
  theme_mozambique
```

```{r child_stunting_study_group_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_anthro" & study_round == "Endline" &
      strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_variable != "severe_wasting_by_oedema" &
      indicator_label == "Child stunting" &
      stringr::str_detect(
        string = indicator_variable, pattern = "global", negate = TRUE
      ) &
      indicator_category != "Mean"
  ) |>
  dplyr::mutate(
    strata = factor(
      strata, 
      levels = c("Zambézia", "Nampula", "Overall")
    ),
    malnutrition_class = ifelse(
      stringr::str_detect(
        string = indicator_variable, pattern = "moderate"
      ), "Moderate", "Severe"
    )
  ) |>
  ggplot(
    mapping = aes(
      x = study_group, y = estimate * 100, fill = malnutrition_class
    )
  ) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "", values = alpha(c("#FFEA00", "#a50026"), 0.6)) +
  scale_y_continuous(
    limits = c(0, 70), breaks = seq(from = 0, to = 70, by = 10)
  ) +
  labs(
    title = "Prevalence of child stunting",
    subtitle = "Proportion of children 6-59 months old who are stunting by study groups in Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~strata, ncol = 3) +
  theme_mozambique
```

### Child underweight

```{r child_underweight, echo = FALSE}
child_underweight_province_overall <- endline_child_anthro_province_table |>
  subset(
    indicator_variable %in% c(
      "wfaz", "global_underweight", "moderate_underweight", "severe_underweight"
    ),
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )()

child_underweight_strata <- endline_child_anthro_strata_table |>
  subset(
    indicator_variable %in% c(
      "wfaz", "global_underweight", "moderate_underweight", "severe_underweight"
    ) &
      strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

child_underweight_study_group <- endline_child_anthro_study_group_table |>
  subset(
    indicator_variable %in% c(
      "wfaz", "global_underweight", "moderate_underweight", "severe_underweight"
    ) &
      study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  child_underweight_province_overall,
  child_underweight_strata,
  child_underweight_study_group
) |>
  (\(x) x[ , c(1, 2, 6, 10, 3, 7, 11, 4, 8, 12, 5, 9, 13)])() |>
  (\(x)
    {
      x[ , 2:4]  <- round(x[ , 2:4], digits = 3)
      x[ , 5:13] <- round(x[ , 5:13] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 4)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Mean Weight-for-Age z-score" = 3, 
      "Global Underweight" = 3, 
      "Moderate Underweight" = 3, 
      "Severe Underweight" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

```{r child_underweight_strata_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_anthro" & study_round == "Endline" &
      !strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_variable != "severe_wasting_by_oedema" &
      indicator_label == "Child underweight" &
      stringr::str_detect(
        string = indicator_variable, pattern = "global", negate = TRUE
      ) &
      indicator_category != "Mean"
  ) |>
  dplyr::mutate(
    province = ifelse(
      strata %in% c("Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"),
      "Nampula", "Zambézia"
    ) |>
      factor(levels = c("Zambézia", "Nampula")),
    strata = factor(
      strata,
      levels = c(
        "Gurúè", "Lugela", "Pebane", "Molumbo", "Rest of Zambézia", 
        "Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"
      ),
      labels = c(
        "\nGurúè", "\nLugela", "\nPebane", "\nMolumbo", "Rest of\nZambézia", 
        "\nMonapo", "\nNacala-A-Velha", "\nRibáuè", "Rest of\nNampula"
      )
    ),
    malnutrition_class = ifelse(
      stringr::str_detect(
        string = indicator_variable, pattern = "moderate"
      ), "Moderate", "Severe"
    )
  ) |>
  ggplot(
    mapping = aes(
      x = strata, y = estimate * 100, fill = malnutrition_class
    )
  ) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "", values = alpha(c("#FFEA00", "#a50026"), 0.6)) +
  scale_y_continuous(
    limits = c(0, 40), breaks = seq(from = 0, to = 40, by = 5)
  ) +
  labs(
    title = "Prevalence of child underweight",
    subtitle = "Proportion of children 6-59 months old who are underweight by districts of Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~province, ncol = 2, scales = "free_x") +
  theme_mozambique
```

```{r child_underweight_study_group_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_anthro" & study_round == "Endline" &
      strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_variable != "severe_wasting_by_oedema" &
      indicator_label == "Child underweight" &
      stringr::str_detect(
        string = indicator_variable, pattern = "global", negate = TRUE
      ) &
      indicator_category != "Mean"
  ) |>
  dplyr::mutate(
    strata = factor(
      strata, 
      levels = c("Zambézia", "Nampula", "Overall")
    ),
    malnutrition_class = ifelse(
      stringr::str_detect(
        string = indicator_variable, pattern = "moderate"
      ), "Moderate", "Severe"
    )
  ) |>
  ggplot(
    mapping = aes(
      x = study_group, y = estimate * 100, fill = malnutrition_class
    )
  ) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "", values = alpha(c("#FFEA00", "#a50026"), 0.6)) +
  scale_y_continuous(
    limits = c(0, 40), breaks = seq(from = 0, to = 40, by = 5)
  ) +
  labs(
    title = "Prevalence of child underweight",
    subtitle = "Proportion of children 6-59 months old who are underweight by study groups in Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~strata, ncol = 3) +
  theme_mozambique
```

### Child wasting by weight-for-height z-score

```{r child_wasting_whz, echo = FALSE}
child_wasting_province_overall <- endline_child_anthro_province_table |>
  subset(
    indicator_label %in% c(
      "Weight-for-height z-score", "Child wasting by weight-for-height z-score"
    ),
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )()

child_wasting_strata <- endline_child_anthro_strata_table |>
  subset(
    indicator_label %in% c(
      "Weight-for-height z-score", "Child wasting by weight-for-height z-score"
    ) &
      strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

child_wasting_study_group <- endline_child_anthro_study_group_table |>
  subset(
    indicator_label %in% c(
      "Weight-for-height z-score", "Child wasting by weight-for-height z-score"
    ) &
      study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  child_wasting_province_overall,
  child_wasting_strata,
  child_wasting_study_group
) |>
  (\(x) x[ , c(1, 2, 6, 10, 3, 7, 11, 4, 8, 12, 5, 9, 13)])() |>
  (\(x)
    {
      x[ , 2:4]  <- round(x[ , 2:4], digits = 3)
      x[ , 5:13] <- round(x[ , 5:13] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 4)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Mean Weight-for-Height z-score" = 3, 
      "Global Wasting" = 3, 
      "Moderate Wasting" = 3, 
      "Severe Wasting" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

```{r child_wasting_whz_strata_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_anthro" & study_round == "Endline" &
      !strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_variable != "severe_wasting_by_oedema" &
      indicator_label == "Child wasting by weight-for-height z-score" &
      stringr::str_detect(
        string = indicator_variable, pattern = "global", negate = TRUE
      ) &
      indicator_category != "Mean"
  ) |>
  dplyr::mutate(
    province = ifelse(
      strata %in% c("Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"),
      "Nampula", "Zambézia"
    ) |>
      factor(levels = c("Zambézia", "Nampula")),
    strata = factor(
      strata,
      levels = c(
        "Gurúè", "Lugela", "Pebane", "Molumbo", "Rest of Zambézia", 
        "Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"
      ),
      labels = c(
        "\nGurúè", "\nLugela", "\nPebane", "\nMolumbo", "Rest of\nZambézia", 
        "\nMonapo", "\nNacala-A-Velha", "\nRibáuè", "Rest of\nNampula"
      )
    ),
    malnutrition_class = ifelse(
      stringr::str_detect(
        string = indicator_variable, pattern = "moderate"
      ), "Moderate", "Severe"
    )
  ) |>
  ggplot(
    mapping = aes(
      x = strata, y = estimate * 100, fill = malnutrition_class
    )
  ) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "", values = alpha(c("#FFEA00", "#a50026"), 0.6)) +
  scale_y_continuous(
    limits = c(0, 15), breaks = seq(from = 0, to = 15, by = 5)
  ) +
  labs(
    title = "Prevalence of child wasting by weight-for-height z-score",
    subtitle = "Proportion of children 6-59 months old who are wasting by weight-for-height z-score by districts of Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~province, ncol = 2, scales = "free_x") +
  theme_mozambique
```

```{r child_wasting_whz_study_group_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_anthro" & study_round == "Endline" &
      strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_variable != "severe_wasting_by_oedema" &
      indicator_label == "Child wasting by weight-for-height z-score" &
      stringr::str_detect(
        string = indicator_variable, pattern = "global", negate = TRUE
      ) &
      indicator_category != "Mean"
  ) |>
  dplyr::mutate(
    strata = factor(
      strata, 
      levels = c("Zambézia", "Nampula", "Overall")
    ),
    malnutrition_class = ifelse(
      stringr::str_detect(
        string = indicator_variable, pattern = "moderate"
      ), "Moderate", "Severe"
    )
  ) |>
  ggplot(
    mapping = aes(
      x = study_group, y = estimate * 100, fill = malnutrition_class
    )
  ) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "", values = alpha(c("#FFEA00", "#a50026"), 0.6)) +
  scale_y_continuous(
    limits = c(0, 15), breaks = seq(from = 0, to = 15, by = 5)
  ) +
  labs(
    title = "Prevalence of child wasting by weight-for-height z-score",
    subtitle = "Proportion of children 6-59 months old who are wasting by weight-for-height z-score by study groups in Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~strata, ncol = 3) +
  theme_mozambique
```

### Child wasting by mid-upper arm circumference

```{r child_wasting_muac, echo = FALSE}
child_wasting_province_overall <- endline_child_anthro_province_table |>
  subset(
    indicator_label %in% c(
      "Mid-upper arm circumference (cms)", "Child wasting by mid-upper arm circumference"
    ),
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )()

child_wasting_strata <- endline_child_anthro_strata_table |>
  subset(
    indicator_label %in% c(
      "Mid-upper arm circumference (cms)", "Child wasting by mid-upper arm circumference"
    ) &
      strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

child_wasting_study_group <- endline_child_anthro_study_group_table |>
  subset(
    indicator_label %in% c(
      "Mid-upper arm circumference (cms)", "Child wasting by mid-upper arm circumference"
    ) &
      study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  child_wasting_province_overall,
  child_wasting_strata,
  child_wasting_study_group
) |>
  (\(x) x[ , c(1, 2, 6, 10, 3, 7, 11, 4, 8, 12, 5, 9, 13)])() |>
  (\(x)
    {
      x[ , 2:4]  <- round(x[ , 2:4], digits = 3)
      x[ , 5:13] <- round(x[ , 5:13] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 4)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Mean Mid-Upper Arm Circumference (cms)" = 3, 
      "Global Wasting" = 3, 
      "Moderate Wasting" = 3, 
      "Severe Wasting" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

```{r child_wasting_muac_strata_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_anthro" & study_round == "Endline" &
      !strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_variable != "severe_wasting_by_oedema" &
      indicator_label == "Child wasting by mid-upper arm circumference" &
      stringr::str_detect(
        string = indicator_variable, pattern = "global", negate = TRUE
      ) &
      indicator_category != "Mean"
  ) |>
  dplyr::mutate(
    province = ifelse(
      strata %in% c("Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"),
      "Nampula", "Zambézia"
    ) |>
      factor(levels = c("Zambézia", "Nampula")),
    strata = factor(
      strata,
      levels = c(
        "Gurúè", "Lugela", "Pebane", "Molumbo", "Rest of Zambézia", 
        "Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"
      ),
      labels = c(
        "\nGurúè", "\nLugela", "\nPebane", "\nMolumbo", "Rest of\nZambézia", 
        "\nMonapo", "\nNacala-A-Velha", "\nRibáuè", "Rest of\nNampula"
      )
    ),
    malnutrition_class = ifelse(
      stringr::str_detect(
        string = indicator_variable, pattern = "moderate"
      ), "Moderate", "Severe"
    )
  ) |>
  ggplot(
    mapping = aes(
      x = strata, y = estimate * 100, fill = malnutrition_class
    )
  ) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "", values = alpha(c("#FFEA00", "#a50026"), 0.6)) +
  scale_y_continuous(
    limits = c(0, 10), breaks = seq(from = 0, to = 10, by = 2)
  ) +
  labs(
    title = "Prevalence of child wasting by mid-upper arm circumference",
    subtitle = "Proportion of children 6-59 months old who are wasting by MUAC by districts of Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~province, ncol = 2, scales = "free_x") +
  theme_mozambique
```

```{r child_wasting_muac_study_group_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_anthro" & study_round == "Endline" &
      strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_variable != "severe_wasting_by_oedema" &
      indicator_label == "Child wasting by mid-upper arm circumference" &
      stringr::str_detect(
        string = indicator_variable, pattern = "global", negate = TRUE
      ) &
      indicator_category != "Mean"
  ) |>
  dplyr::mutate(
    strata = factor(
      strata, 
      levels = c("Zambézia", "Nampula", "Overall")
    ),
    malnutrition_class = ifelse(
      stringr::str_detect(
        string = indicator_variable, pattern = "moderate"
      ), "Moderate", "Severe"
    )
  ) |>
  ggplot(
    mapping = aes(
      x = study_group, y = estimate * 100, fill = malnutrition_class
    )
  ) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "", values = alpha(c("#FFEA00", "#a50026"), 0.6)) +
  scale_y_continuous(
    limits = c(0, 10), breaks = seq(from = 0, to = 10, by = 2)
  ) +
  labs(
    title = "Prevalence of child wasting by mid-upper arm circumference",
    subtitle = "Proportion of children 6-59 months old who are wasting by MUAC by study groups in Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~strata, ncol = 3) +
  theme_mozambique
```

### Severe wasting by nutritional oedema

```{r child_wasting_oedema, echo = FALSE}
child_oedema_province_overall <- endline_child_anthro_province_table |>
  subset(
    indicator_label == "Child wasting by oedema",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )()

child_oedema_strata <- endline_child_anthro_strata_table |>
  subset(
    indicator_label == "Child wasting by oedema" &
      strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

child_oedema_study_group <- endline_child_anthro_study_group_table |>
  subset(
    indicator_label == "Child wasting by oedema" &
      study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  child_oedema_province_overall,
  child_oedema_strata,
  child_oedema_study_group
) |>
  (\(x)
    {
      x[ , 2:4]  <- round(x[ , 2:4], digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", "Estimate", "95% LCL", "95% UCL"),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = FALSE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Severe wasting by oedema" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

<br/>

## Child anthropometry - 6 to 35 months

```{r child_anthro_subset_province_plot, fig.align = "center", fig.width = 10, fig.height = 8}
overall_results_all |>
  subset(
    indicator_set_code == "child_anthro_subset" & study_round == "Endline" &
      strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_variable != "severe_wasting_by_oedema" &
      stringr::str_detect(
        string = indicator_variable, pattern = "global", negate = TRUE
      ) &
      indicator_category != "Mean"
  ) |>
  dplyr::mutate(
    strata = factor(strata, levels = c("Zambézia", "Nampula", "Overall")),
    malnutrition_class = ifelse(
      stringr::str_detect(
        string = indicator_variable, pattern = "moderate"
      ), "Moderate", "Severe"
    ),
    indicator_label = factor(
      indicator_label,
      label = c("Stunting", "Underweight", "Wasting (MUAC)", "Wasting (WHZ)")
    )
  ) |>
  ggplot(
    mapping = aes(
      x = study_group, y = estimate * 100, fill = malnutrition_class
    )
  ) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "", values = alpha(c("#FFEA00", "#a50026"), 0.6)) +
  labs(
    title = "Prevalence of child undernutrition",
    subtitle = "Proportion of children 6-35 months old who are stunting, underweight, and wasting",
    x = "", y = "%"
  ) +
  facet_grid(
    rows = vars(indicator_label), cols = vars(strata), scales = "free_y"
  ) +
  theme_mozambique
```

### Child Stunting

```{r child_stunting_subset, echo = FALSE}
child_stunting_province_overall <- endline_child_anthro_subset_province_table |>
  subset(
    indicator_variable %in% c(
      "hfaz", "global_stunting", "moderate_stunting", "severe_stunting"
    ),
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )()

child_stunting_strata <- endline_child_anthro_subset_strata_table |>
  subset(
    indicator_variable %in% c(
      "hfaz", "global_stunting", "moderate_stunting", "severe_stunting"
    ) &
      strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

child_stunting_study_group <- endline_child_anthro_subset_study_group_table |>
  subset(
    indicator_variable %in% c(
      "hfaz", "global_stunting", "moderate_stunting", "severe_stunting"
    ) &
      study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  child_stunting_province_overall,
  child_stunting_strata,
  child_stunting_study_group
) |>
  (\(x) x[ , c(1, 2, 6, 10, 3, 7, 11, 4, 8, 12, 5, 9, 13)])() |>
  (\(x)
    {
      x[ , 2:4]  <- round(x[ , 2:4], digits = 3)
      x[ , 5:13] <- round(x[ , 5:13] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 4)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Mean Height-for-Age z-score" = 3, 
      "Global Stunting" = 3, 
      "Moderate Stunting" = 3, 
      "Severe Stunting" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

```{r child_stunting_subset_strata_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_anthro_subset" & study_round == "Endline" &
      !strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_variable != "severe_wasting_by_oedema" &
      indicator_label == "Child stunting" &
      stringr::str_detect(
        string = indicator_variable, pattern = "global", negate = TRUE
      ) &
      indicator_category != "Mean"
  ) |>
  dplyr::mutate(
    province = ifelse(
      strata %in% c("Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"),
      "Nampula", "Zambézia"
    ) |>
      factor(levels = c("Zambézia", "Nampula")),
    strata = factor(
      strata,
      levels = c(
        "Gurúè", "Lugela", "Pebane", "Molumbo", "Rest of Zambézia", 
        "Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"
      ),
      labels = c(
        "\nGurúè", "\nLugela", "\nPebane", "\nMolumbo", "Rest of\nZambézia", 
        "\nMonapo", "\nNacala-A-Velha", "\nRibáuè", "Rest of\nNampula"
      )
    ),
    malnutrition_class = ifelse(
      stringr::str_detect(
        string = indicator_variable, pattern = "moderate"
      ), "Moderate", "Severe"
    )
  ) |>
  ggplot(
    mapping = aes(
      x = strata, y = estimate * 100, fill = malnutrition_class
    )
  ) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "", values = alpha(c("#FFEA00", "#a50026"), 0.6)) +
  scale_y_continuous(
    limits = c(0, 70), breaks = seq(from = 0, to = 70, by = 10)
  ) +
  labs(
    title = "Prevalence of child stunting",
    subtitle = "Proportion of children 6-35 months old who are stunting by district of Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~province, ncol = 2, scales = "free_x") +
  theme_mozambique
```

```{r child_stunting_subset_study_group_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_anthro_subset" & study_round == "Endline" &
      strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_variable != "severe_wasting_by_oedema" &
      indicator_label == "Child stunting" &
      stringr::str_detect(
        string = indicator_variable, pattern = "global", negate = TRUE
      ) &
      indicator_category != "Mean"
  ) |>
  dplyr::mutate(
    strata = factor(
      strata, 
      levels = c("Zambézia", "Nampula", "Overall")
    ),
    malnutrition_class = ifelse(
      stringr::str_detect(
        string = indicator_variable, pattern = "moderate"
      ), "Moderate", "Severe"
    )
  ) |>
  ggplot(
    mapping = aes(
      x = study_group, y = estimate * 100, fill = malnutrition_class
    )
  ) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "", values = alpha(c("#FFEA00", "#a50026"), 0.6)) +
  scale_y_continuous(
    limits = c(0, 70), breaks = seq(from = 0, to = 70, by = 10)
  ) +
  labs(
    title = "Prevalence of child stunting",
    subtitle = "Proportion of children 6-35 months old who are stunting by study groups in Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~strata, ncol = 3) +
  theme_mozambique
```

### Child underweight

```{r child_underweight_subset, echo = FALSE}
child_underweight_province_overall <- endline_child_anthro_subset_province_table |>
  subset(
    indicator_variable %in% c(
      "wfaz", "global_underweight", "moderate_underweight", "severe_underweight"
    ),
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )()

child_underweight_strata <- endline_child_anthro_subset_strata_table |>
  subset(
    indicator_variable %in% c(
      "wfaz", "global_underweight", "moderate_underweight", "severe_underweight"
    ) &
      strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

child_underweight_study_group <- endline_child_anthro_subset_study_group_table |>
  subset(
    indicator_variable %in% c(
      "wfaz", "global_underweight", "moderate_underweight", "severe_underweight"
    ) &
      study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  child_underweight_province_overall,
  child_underweight_strata,
  child_underweight_study_group
) |>
  (\(x) x[ , c(1, 2, 6, 10, 3, 7, 11, 4, 8, 12, 5, 9, 13)])() |>
  (\(x)
    {
      x[ , 2:4]  <- round(x[ , 2:4], digits = 3)
      x[ , 5:13] <- round(x[ , 5:13] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 4)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Mean Weight-for-Age z-score" = 3, 
      "Global Underweight" = 3, 
      "Moderate Underweight" = 3, 
      "Severe Underweight" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

```{r child_underweight_subset_strata_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_anthro_subset" & study_round == "Endline" &
      !strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_variable != "severe_wasting_by_oedema" &
      indicator_label == "Child underweight" &
      stringr::str_detect(
        string = indicator_variable, pattern = "global", negate = TRUE
      ) &
      indicator_category != "Mean"
  ) |>
  dplyr::mutate(
    province = ifelse(
      strata %in% c("Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"),
      "Nampula", "Zambézia"
    ) |>
      factor(levels = c("Zambézia", "Nampula")),
    strata = factor(
      strata,
      levels = c(
        "Gurúè", "Lugela", "Pebane", "Molumbo", "Rest of Zambézia", 
        "Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"
      ),
      labels = c(
        "\nGurúè", "\nLugela", "\nPebane", "\nMolumbo", "Rest of\nZambézia", 
        "\nMonapo", "\nNacala-A-Velha", "\nRibáuè", "Rest of\nNampula"
      )
    ),
    malnutrition_class = ifelse(
      stringr::str_detect(
        string = indicator_variable, pattern = "moderate"
      ), "Moderate", "Severe"
    )
  ) |>
  ggplot(
    mapping = aes(
      x = strata, y = estimate * 100, fill = malnutrition_class
    )
  ) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "", values = alpha(c("#FFEA00", "#a50026"), 0.6)) +
  scale_y_continuous(
    limits = c(0, 40), breaks = seq(from = 0, to = 40, by = 5)
  ) +
  labs(
    title = "Prevalence of child underweight",
    subtitle = "Proportion of children 6-35 months old who are underweight by districts of Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~province, ncol = 2, scales = "free_x") +
  theme_mozambique
```

```{r child_underweight_subset_study_group_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_anthro_subset" & study_round == "Endline" &
      strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_variable != "severe_wasting_by_oedema" &
      indicator_label == "Child underweight" &
      stringr::str_detect(
        string = indicator_variable, pattern = "global", negate = TRUE
      ) &
      indicator_category != "Mean"
  ) |>
  dplyr::mutate(
    strata = factor(
      strata, 
      levels = c("Zambézia", "Nampula", "Overall")
    ),
    malnutrition_class = ifelse(
      stringr::str_detect(
        string = indicator_variable, pattern = "moderate"
      ), "Moderate", "Severe"
    )
  ) |>
  ggplot(
    mapping = aes(
      x = study_group, y = estimate * 100, fill = malnutrition_class
    )
  ) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "", values = alpha(c("#FFEA00", "#a50026"), 0.6)) +
  scale_y_continuous(
    limits = c(0, 40), breaks = seq(from = 0, to = 40, by = 5)
  ) +
  labs(
    title = "Prevalence of child underweight",
    subtitle = "Proportion of children 6-35 months old who are underweight by study groups in Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~strata, ncol = 3) +
  theme_mozambique
```

### Child wasting by weight-for-height z-score

```{r child_wasting_whz_subset, echo = FALSE}
child_wasting_province_overall <- endline_child_anthro_subset_province_table |>
  subset(
    indicator_label %in% c(
      "Weight-for-height z-score", "Child wasting by weight-for-height z-score"
    ),
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )()

child_wasting_strata <- endline_child_anthro_subset_strata_table |>
  subset(
    indicator_label %in% c(
      "Weight-for-height z-score", "Child wasting by weight-for-height z-score"
    ) &
      strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

child_wasting_study_group <- endline_child_anthro_subset_study_group_table |>
  subset(
    indicator_label %in% c(
      "Weight-for-height z-score", "Child wasting by weight-for-height z-score"
    ) &
      study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  child_wasting_province_overall,
  child_wasting_strata,
  child_wasting_study_group
) |>
  (\(x) x[ , c(1, 2, 6, 10, 3, 7, 11, 4, 8, 12, 5, 9, 13)])() |>
  (\(x)
    {
      x[ , 2:4]  <- round(x[ , 2:4], digits = 3)
      x[ , 5:13] <- round(x[ , 5:13] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 4)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Mean Weight-for-Height z-score" = 3, 
      "Global Wasting" = 3, 
      "Moderate Wasting" = 3, 
      "Severe Wasting" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

```{r child_wasting_whz_susbet_strata_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_anthro_subset" & study_round == "Endline" &
      !strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_variable != "severe_wasting_by_oedema" &
      indicator_label == "Child wasting by weight-for-height z-score" &
      stringr::str_detect(
        string = indicator_variable, pattern = "global", negate = TRUE
      ) &
      indicator_category != "Mean"
  ) |>
  dplyr::mutate(
    province = ifelse(
      strata %in% c("Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"),
      "Nampula", "Zambézia"
    ) |>
      factor(levels = c("Zambézia", "Nampula")),
    strata = factor(
      strata,
      levels = c(
        "Gurúè", "Lugela", "Pebane", "Molumbo", "Rest of Zambézia", 
        "Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"
      ),
      labels = c(
        "\nGurúè", "\nLugela", "\nPebane", "\nMolumbo", "Rest of\nZambézia", 
        "\nMonapo", "\nNacala-A-Velha", "\nRibáuè", "Rest of\nNampula"
      )
    ),
    malnutrition_class = ifelse(
      stringr::str_detect(
        string = indicator_variable, pattern = "moderate"
      ), "Moderate", "Severe"
    )
  ) |>
  ggplot(
    mapping = aes(
      x = strata, y = estimate * 100, fill = malnutrition_class
    )
  ) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "", values = alpha(c("#FFEA00", "#a50026"), 0.6)) +
  scale_y_continuous(
    limits = c(0, 16), breaks = seq(from = 0, to = 16, by = 2)
  ) +
  labs(
    title = "Prevalence of child wasting by weight-for-height z-score",
    subtitle = "Proportion of children 6-35 months old who are wasting by weight-for-height z-score by districts of Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~province, ncol = 2, scales = "free_x") +
  theme_mozambique
```

```{r child_wasting_whz_subset_study_group_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_anthro_subset" & study_round == "Endline" &
      strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_variable != "severe_wasting_by_oedema" &
      indicator_label == "Child wasting by weight-for-height z-score" &
      stringr::str_detect(
        string = indicator_variable, pattern = "global", negate = TRUE
      ) &
      indicator_category != "Mean"
  ) |>
  dplyr::mutate(
    strata = factor(
      strata, 
      levels = c("Zambézia", "Nampula", "Overall")
    ),
    malnutrition_class = ifelse(
      stringr::str_detect(
        string = indicator_variable, pattern = "moderate"
      ), "Moderate", "Severe"
    )
  ) |>
  ggplot(
    mapping = aes(
      x = study_group, y = estimate * 100, fill = malnutrition_class
    )
  ) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "", values = alpha(c("#FFEA00", "#a50026"), 0.6)) +
  scale_y_continuous(
    limits = c(0, 16), breaks = seq(from = 0, to = 16, by = 2)
  ) +
  labs(
    title = "Prevalence of child wasting by weight-for-height z-score",
    subtitle = "Proportion of children 6-35 months old who are wasting by weight-for-height z-score by study groups in Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~strata, ncol = 3) +
  theme_mozambique
```

### Child wasting by mid-upper arm circumference

```{r child_wasting_muac_subset, echo = FALSE}
child_wasting_province_overall <- endline_child_anthro_subset_province_table |>
  subset(
    indicator_label %in% c(
      "Mid-upper arm circumference (cms)", "Child wasting by mid-upper arm circumference"
    ),
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )()

child_wasting_strata <- endline_child_anthro_subset_strata_table |>
  subset(
    indicator_label %in% c(
      "Mid-upper arm circumference (cms)", "Child wasting by mid-upper arm circumference"
    ) &
      strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

child_wasting_study_group <- endline_child_anthro_subset_study_group_table |>
  subset(
    indicator_label %in% c(
      "Mid-upper arm circumference (cms)", "Child wasting by mid-upper arm circumference"
    ) &
      study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  child_wasting_province_overall,
  child_wasting_strata,
  child_wasting_study_group
) |>
  (\(x) x[ , c(1, 2, 6, 10, 3, 7, 11, 4, 8, 12, 5, 9, 13)])() |>
  (\(x)
    {
      x[ , 2:4]  <- round(x[ , 2:4], digits = 3)
      x[ , 5:13] <- round(x[ , 5:13] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 4)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Mean Mid-Upper Arm Circumference (cms)" = 3, 
      "Global Wasting" = 3, 
      "Moderate Wasting" = 3, 
      "Severe Wasting" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

```{r child_wasting_muac_subset_strata_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_anthro_subset" & study_round == "Endline" &
      !strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_variable != "severe_wasting_by_oedema" &
      indicator_label == "Child wasting by mid-upper arm circumference" &
      stringr::str_detect(
        string = indicator_variable, pattern = "global", negate = TRUE
      ) &
      indicator_category != "Mean"
  ) |>
  dplyr::mutate(
    province = ifelse(
      strata %in% c("Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"),
      "Nampula", "Zambézia"
    ) |>
      factor(levels = c("Zambézia", "Nampula")),
    strata = factor(
      strata,
      levels = c(
        "Gurúè", "Lugela", "Pebane", "Molumbo", "Rest of Zambézia", 
        "Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"
      ),
      labels = c(
        "\nGurúè", "\nLugela", "\nPebane", "\nMolumbo", "Rest of\nZambézia", 
        "\nMonapo", "\nNacala-A-Velha", "\nRibáuè", "Rest of\nNampula"
      )
    ),
    malnutrition_class = ifelse(
      stringr::str_detect(
        string = indicator_variable, pattern = "moderate"
      ), "Moderate", "Severe"
    )
  ) |>
  ggplot(
    mapping = aes(
      x = strata, y = estimate * 100, fill = malnutrition_class
    )
  ) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "", values = alpha(c("#FFEA00", "#a50026"), 0.6)) +
  scale_y_continuous(
    limits = c(0, 16), breaks = seq(from = 0, to = 16, by = 2)
  ) +
  labs(
    title = "Prevalence of child wasting by mid-upper arm circumference",
    subtitle = "Proportion of children 6-35 months old who are wasting by MUAC by districts of Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~province, ncol = 2, scales = "free_x") +
  theme_mozambique
```

```{r child_wasting_muac_subset_study_group_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_anthro_subset" & study_round == "Endline" &
      strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_variable != "severe_wasting_by_oedema" &
      indicator_label == "Child wasting by mid-upper arm circumference" &
      stringr::str_detect(
        string = indicator_variable, pattern = "global", negate = TRUE
      ) &
      indicator_category != "Mean"
  ) |>
  dplyr::mutate(
    strata = factor(
      strata, 
      levels = c("Zambézia", "Nampula", "Overall")
    ),
    malnutrition_class = ifelse(
      stringr::str_detect(
        string = indicator_variable, pattern = "moderate"
      ), "Moderate", "Severe"
    )
  ) |>
  ggplot(
    mapping = aes(
      x = study_group, y = estimate * 100, fill = malnutrition_class
    )
  ) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "", values = alpha(c("#FFEA00", "#a50026"), 0.6)) +
  scale_y_continuous(
    limits = c(0, 16), breaks = seq(from = 0, to = 16, by = 2)
  ) +
  labs(
    title = "Prevalence of child wasting by mid-upper arm circumference",
    subtitle = "Proportion of children 6-35 months old who are wasting by MUAC by study groups in Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~strata, ncol = 3) +
  theme_mozambique
```

### Severe wasting by nutritional oedema

```{r child_wasting_oedema_subset, echo = FALSE}
child_oedema_province_overall <- endline_child_anthro_subset_province_table |>
  subset(
    indicator_label == "Child wasting by oedema",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )()

child_oedema_strata <- endline_child_anthro_subset_strata_table |>
  subset(
    indicator_label == "Child wasting by oedema" &
      strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

child_oedema_study_group <- endline_child_anthro_subset_study_group_table |>
  subset(
    indicator_label == "Child wasting by oedema" &
      study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  child_oedema_province_overall,
  child_oedema_strata,
  child_oedema_study_group
) |>
  (\(x)
    {
      x[ , 2:4]  <- round(x[ , 2:4], digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", "Estimate", "95% LCL", "95% UCL"),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = FALSE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Severe wasting by oedema" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

<br/>

## Infant and young chlid feeding

### Food groups consumed

#### By province and overall

```{r child_food_groups, echo = FALSE}
endline_iycf_province_table_report |>
  subset(
    !indicator_category %in% c("Mean", "Minimum dietary diversity"),
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Food group", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  )
```

#### By study group and overall

```{r child_food_groups_study_group, echo = FALSE}
endline_iycf_study_group_table_report |>
  subset(
    !indicator_category %in% c("Mean", "Minimum dietary diversity"),
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Food group", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  )
```

### Minimum dietary diversity

```{r iycf_mdd, echo = FALSE}
mdd_province_overall <- endline_iycf_province_table |>
  subset(
    indicator_label %in% c("Food groups score", "Minimum dietary diversity"),
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )()
 
mdd_strata <- endline_iycf_strata_table |>
  subset(
    indicator_label %in% c("Food groups score", "Minimum dietary diversity") &
      strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

mdd_study_group <- endline_iycf_study_group_table |>
  subset(
    indicator_label %in% c("Food groups score", "Minimum dietary diversity") &
      study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()
 
rbind(
  mdd_province_overall, mdd_strata, mdd_study_group
) |>
  (\(x) x[ , c(1, 2, 4, 6, 3, 5, 7)])() |>
  (\(x)
    {
      x[ , 2:4]  <- round(x[ , 2:4], digits = 2)
      x[ , 5:7]  <- round(x[ , 5:7] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 2)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = FALSE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Mean Food Groups Score" = 3,
      "Minimum dietary diversity" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

### Minimum meal frequency

This indicator cannot be calculated using the endline data provided by UNICEF Mozambique. Specifically, the dataset provided has information on the frequency of solid or semi-solid feeds by children discretised rather than kept in actual number of feeds as reported by the respondent. The discretisation was also done in such a way that does not match groupings in the indicator definition.

### Minimum adequate diet

This indicator cannot be calculated using the endline data provided by UNICEF Mozambique. This compound indicator requires information about minimum meal frequency to be calculated. As described above, the dataset provided by UNICEF Mozambique does not allow for the calculation of the minimum meal frequency.

<br/>

## Period prevalence of childhood illnesses

```{r child_ill_province_plot, fig.align = "center", fig.width = 10, fig.height = 8}
overall_results_all |>
  subset(
    indicator_set_code == "child_ill" & 
      study_round == "Endline" &
      strata %in% c("Zambézia", "Nampula", "Overall")
  ) |>
  dplyr::mutate(
    strata = factor(strata, levels = c("Zambézia", "Nampula", "Overall")),
    indicator_category = factor(
      x = indicator_category,
      levels = c(
        "Diarrhoea episode in past 2 weeks",
        "Fever episode in past 2 weeks",
        "Cough episode in past 2 weeks"
      ),
      labels = c("Diarrhoea", "Fever", "Cough")
    )
  ) |>
  ggplot(mapping = aes(x = study_group, y = estimate * 100)) +
  geom_bar(stat = "identity", fill = alpha(unicef_blue, 0.6)) +
  scale_y_continuous(
    limits = c(0, 60), breaks = seq(from = 0, to = 60, by = 10)
  ) +
  labs(
    title = "Period prevalence of child illnesses",
    subtitle = "Proportion of children 0-59 months old who had diarrhoea, fever, or cough in the past 2 weeks",
    x = "", y = "%"
  ) +
  facet_grid(
    rows = vars(indicator_category), cols = vars(strata), scales = "free_y"
  ) +
  theme_mozambique
```

<br/>

```{r child_diarrhoea_strata_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_ill" & study_round == "Endline" &
      !strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_category == "Diarrhoea episode in past 2 weeks"
  ) |>
  dplyr::mutate(
    province = ifelse(
      strata %in% c("Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"),
      "Nampula", "Zambézia"
    ) |>
      factor(levels = c("Zambézia", "Nampula")),
    strata = factor(
      strata, 
      levels = c(
        "Gurúè", "Lugela", "Pebane", "Molumbo", "Rest of Zambézia", 
        "Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"
      ),
      labels = c(
        "\nGurúè", "\nLugela", "\nPebane", "\nMolumbo", "Rest of\nZambézia", 
        "\nMonapo", "\nNacala-A-Velha", "\nRibáuè", "Rest of\nNampula"
      )
    )
  ) |>
  ggplot(
    mapping = aes(x = strata, y = estimate * 100)) +
  geom_bar(stat = "identity", fill = alpha(unicef_blue, 0.6)) +
  labs(
    title = "Prevalence of diarrhoea",
    subtitle = "Proportion of children 0-59 months old who had diarrhoea in the past 2 weeks by districts of Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~province, ncol = 2, scales = "free_x") +
  theme_mozambique
```

```{r child_diarrhoea_study_group_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_ill" & study_round == "Endline" &
      strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_category == "Diarrhoea episode in past 2 weeks"
  ) |>
  dplyr::mutate(
    strata = factor(
      strata, 
      levels = c("Zambézia", "Nampula", "Overall")
    )
  ) |>
  ggplot(
    mapping = aes(x = study_group, y = estimate * 100)) +
  geom_bar(stat = "identity", fill = alpha(unicef_blue, 0.6)) +
  scale_y_continuous(
    limits = c(0, 20), breaks = seq(from = 0, to = 20, by = 5)
  ) +
  labs(
    title = "Prevalence of diarrhoea",
    subtitle = "Proportion of children 0-59 months old who had diarrhoea in the past 2 weeks by study groups in Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~strata, ncol = 3) +
  theme_mozambique
```

<br/>

```{r child_fever_strata_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_ill" & study_round == "Endline" &
      !strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_category == "Fever episode in past 2 weeks"
  ) |>
  dplyr::mutate(
    province = ifelse(
      strata %in% c("Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"),
      "Nampula", "Zambézia"
    ) |>
      factor(levels = c("Zambézia", "Nampula")),
    strata = factor(
      strata, 
      levels = c(
        "Gurúè", "Lugela", "Pebane", "Molumbo", "Rest of Zambézia", 
        "Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"
      ),
      labels = c(
        "\nGurúè", "\nLugela", "\nPebane", "\nMolumbo", "Rest of\nZambézia", 
        "\nMonapo", "\nNacala-A-Velha", "\nRibáuè", "Rest of\nNampula"
      )
    )
  ) |>
  ggplot(
    mapping = aes(x = strata, y = estimate * 100)) +
  geom_bar(stat = "identity", fill = alpha(unicef_blue, 0.6)) +
  scale_y_continuous(
    limits = c(0, 70), breaks = seq(from = 0, to = 70, by = 10)
  ) +
  labs(
    title = "Prevalence of fever",
    subtitle = "Proportion of children 0-59 months old who had fever in the past 2 weeks by districts of Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~province, ncol = 2, scales = "free_x") +
  theme_mozambique
```

```{r child_fever_study_group_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_ill" & study_round == "Endline" &
      strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_category == "Fever episode in past 2 weeks"
  ) |>
  dplyr::mutate(
    strata = factor(
      strata, 
      levels = c("Zambézia", "Nampula", "Overall")
    )
  ) |>
  ggplot(
    mapping = aes(x = study_group, y = estimate * 100)) +
  geom_bar(stat = "identity", fill = alpha(unicef_blue, 0.6)) +
  labs(
    title = "Prevalence of fever",
    subtitle = "Proportion of children 0-59 months old who had fever in the past 2 weeks by study groups in Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~strata, ncol = 3) +
  theme_mozambique
```

<br/>

```{r child_cough_strata_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_ill" & study_round == "Endline" &
      !strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_category == "Cough episode in past 2 weeks"
  ) |>
  dplyr::mutate(
    province = ifelse(
      strata %in% c("Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"),
      "Nampula", "Zambézia"
    ) |>
      factor(levels = c("Zambézia", "Nampula")),
    strata = factor(
      strata, 
      levels = c(
        "Gurúè", "Lugela", "Pebane", "Molumbo", "Rest of Zambézia", 
        "Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"
      ),
      labels = c(
        "\nGurúè", "\nLugela", "\nPebane", "\nMolumbo", "Rest of\nZambézia", 
        "\nMonapo", "\nNacala-A-Velha", "\nRibáuè", "Rest of\nNampula"
      )
    )
  ) |>
  ggplot(
    mapping = aes(x = strata, y = estimate * 100)) +
  geom_bar(stat = "identity", fill = alpha(unicef_blue, 0.6)) +
  scale_y_continuous(
    limits = c(0, 30), breaks = seq(from = 0, to = 30, by = 5)
  ) +
  labs(
    title = "Prevalence of cough",
    subtitle = "Proportion of children 0-59 months old who had cough in the past 2 weeks by districts of Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~province, ncol = 2, scales = "free_x") +
  theme_mozambique
```

```{r child_cough_study_group_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "child_ill" & study_round == "Endline" &
      strata %in% c("Zambézia", "Nampula", "Overall") & 
      indicator_category == "Cough episode in past 2 weeks"
  ) |>
  dplyr::mutate(
    strata = factor(
      strata, 
      levels = c("Zambézia", "Nampula", "Overall")
    )
  ) |>
  ggplot(
    mapping = aes(x = study_group, y = estimate * 100)) +
  geom_bar(stat = "identity", fill = alpha(unicef_blue, 0.6)) +
  labs(
    title = "Prevalence of cough",
    subtitle = "Proportion of children 0-59 months old who had cough in the past 2 weeks by study groups in Zambézia and Nampula",
    x = "", y = "%"
  ) +
  facet_wrap(~strata, ncol = 3) +
  theme_mozambique
```

<br/>

```{r child_illness, echo = FALSE}
child_ill_province_overall <- endline_child_ill_province_table |>
  subset(
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )()

child_ill_strata <- endline_child_ill_strata_table |>
  subset(
    strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

child_ill_study_group <- endline_child_ill_study_group_table |>
  subset(
    study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  child_ill_province_overall,
  child_ill_strata,
  child_ill_study_group
) |>
  (\(x) x[ , c(1, 2, 5, 8, 3, 6, 9, 4, 7, 10)])() |>
  (\(x)
    {
      x[ , 2:10]  <- round(x[ , 2:10] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Diarrhoea" = 3, 
      "Fever" = 3, 
      "Cough" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

### Treatment seeking for diarrhoea

#### By province and overall

```{r diarrhoea_treatment, echo = FALSE}
rbind(
  endline_diarrhoea_treatment_province_table_report,
  endline_diarrhoea_treatment1_province_table_report
) |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Treatment for diarrhoea" = 1,
      "Point-of-care for diarrhoea" = 8,
      "Use of oral rehydration solution" = 1
    )
  )
```

#### By study group and overall

```{r diarrhoea_treatment_study_group, echo = FALSE}
rbind(
  endline_diarrhoea_treatment_study_group_table_report,
  endline_diarrhoea_treatment1_study_group_table_report
) |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Treatment for diarrhoea" = 1,
      "Point-of-care for diarrhoea" = 8,
      "Use of oral rehydration solution" = 1
    )
  )
```

### Treatment seeking for fever

#### By province and overall

```{r fever_treatment, echo = FALSE}
rbind(
  endline_fever_treatment_province_table_report,
  endline_fever_treatment1_province_table_report,
  endline_malaria_test_province_table_report,
  endline_malaria_test1_province_table_report,
  endline_malaria_treatment_province_table_report
) |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Treatment for fever" = 1,
      "Point-of-care for fever" = 8,
      "Malaria testing" = 2,
      "Malaria treatment" = 7,
      "Malaria treatment consumption" = 1
    )
  )
```

#### By study group and overall

```{r fever_treatment_study_group, echo = FALSE}
rbind(
  endline_fever_treatment_study_group_table_report,
  endline_fever_treatment1_study_group_table_report,
  endline_malaria_test_study_group_table_report,
  endline_malaria_test1_study_group_table_report,
  endline_malaria_treatment_study_group_table_report
) |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Treatment for fever" = 1,
      "Point-of-care for fever" = 8,
      "Malaria testing" = 2,
      "Malaria treatment" = 7,
      "Malaria treatment consumption" = 1
    )
  )
```

### Treatment seeking for cough

#### By province and overall

```{r cough_treatment, echo = FALSE}
rbind(
  endline_rti_treatment_province_table_report,
  endline_rti_treatment1_province_table_report,
  endline_rti_treatment_type_province_table_report
) |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Treatment for cough" = 1,
      "Point-of-care for cough" = 8,
      "Treatment for cough" = 5
    )
  )
```

#### By study group and overall

```{r cough_treatment_study_group, echo = FALSE}
rbind(
  endline_rti_treatment_study_group_table_report,
  endline_rti_treatment1_study_group_table_report,
  endline_rti_treatment_type_study_group_table_report
) |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Treatment for cough" = 1,
      "Point-of-care for cough" = 8,
      "Treatment for cough" = 5
    )
  )
```

<br/>

## Water, sanitation, and hygiene

### Water

```{r water_province_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "wash" & 
      indicator_label == "Water source" &
      study_round == "Endline" &
      strata %in% c("Zambézia", "Nampula", "Overall")
  ) |>
  dplyr::mutate(
    strata = factor(strata, levels = c("Zambézia", "Nampula", "Overall")),
    indicator_category = factor(
      x = indicator_category,
      levels = c(
        "Surface water", "Unimproved", "Limited", "Basic", "Sufficient"
      )
    )
  ) |>
  ggplot(mapping = aes(x = study_group, y = estimate, fill = indicator_category)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(name = "", values = alpha(rev(water_ladder), 0.6)) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Drinking water service ladder",
    subtitle = "Proportion of households in Zambézia and Nampula by source of drinking water",
    x = "", y = "%"
  ) +
  facet_wrap(~strata) +
  theme_mozambique
```

<br/>

```{r water_strata_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "wash" & 
      indicator_label == "Water source" &
      study_round == "Endline" &
      !strata %in% c("Zambézia", "Nampula", "Overall")
  ) |>
  dplyr::mutate(
    province = ifelse(
      strata %in% c("Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"),
      "Nampula", "Zambézia"
    ) |>
      factor(levels = c("Zambézia", "Nampula")),
    strata = factor(
      strata, 
      levels = c(
        "Gurúè", "Lugela", "Pebane", "Molumbo", "Rest of Zambézia", 
        "Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"
      ),
      labels = c(
        "\nGurúè", "\nLugela", "\nPebane", "\nMolumbo", "Rest of\nZambézia", 
        "\nMonapo", "\nNacala-A-Velha", "\nRibáuè", "Rest of\nNampula"
      )
    ),
    indicator_category = factor(
      x = indicator_category,
      levels = c(
        "Surface water", "Unimproved", "Limited", "Basic", "Sufficient"
      )
    )
  ) |>
  ggplot(mapping = aes(x = strata, y = estimate, fill = indicator_category)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(name = "", values = alpha(rev(water_ladder), 0.6)) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Drinking water service ladder",
    subtitle = "Proportion of households in districts of Zambézia and Nampula by source of drinking water",
    x = "", y = "%"
  ) +
  facet_wrap(~province, ncol = 2, scales = "free_x") +
  theme_mozambique
```

<br/>

```{r water, echo = FALSE}
water_province_overall <- endline_wash_province_table |>
  subset(
    indicator_label == "Water source",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )()

water_strata <- endline_wash_strata_table |>
  subset(
    indicator_label == "Water source" &
      strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

water_study_group <- endline_wash_study_group_table |>
  subset(
    indicator_label == "Water source" &
      study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  water_province_overall,
  water_strata,
  water_study_group
) |>
  (\(x) x[ , c(1, 2, 7, 12, 3, 8, 13, 4, 9, 14, 5, 10, 15, 6, 11, 16)])() |>
  (\(x)
    {
      x[ , 2:16] <- round(x[ , 2:16] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 5)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Surface water" = 3, 
      "Unimproved" = 3, 
      "Limited" = 3, 
      "Basic" = 3,
      "Sufficient" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

```{r good_water_source, echo = FALSE}
water_subset_province_overall <- endline_wash_subset_province_table |>
  subset(
    indicator_category == "Good water source",
    select = c(indicator_label, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )()

water_subset_strata <- endline_wash_subset_strata_table |>
  subset(
    indicator_category == "Good water source" & strata != "Overall",
    select = c(indicator_label, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

water_subset_study_group <- endline_wash_subset_study_group_table |>
  subset(
    indicator_category == "Good water source" & study_group != "Overall",
    select = c(indicator_label, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  water_subset_province_overall,
  water_subset_strata,
  water_subset_study_group
) |>
  (\(x)
    {
      x[ , 2:4] <- round(x[ , 2:4] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", c("Estimate", "95% LCL", "95% UCL")),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = FALSE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Good water source" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

### Sanitation

```{r sanitation_province_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "wash" & 
      indicator_label == "Toilet facility" &
      study_round == "Endline" &
      strata %in% c("Zambézia", "Nampula", "Overall")
  ) |>
  dplyr::mutate(
    strata = factor(strata, levels = c("Zambézia", "Nampula", "Overall")),
    indicator_category = factor(
      x = indicator_category,
      levels = c("Open defecation", "Unimproved", "Limited", "Basic")
    )
  ) |>
  ggplot(mapping = aes(x = study_group, y = estimate, fill = indicator_category)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(name = "", values = alpha(rev(sanitation_ladder), 0.6)) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Sanitation service ladder",
    subtitle = "Proportion of households in Zambézia and Nampula by type of sanitation facility",
    x = "", y = "%"
  ) +
  facet_wrap(~strata) +
  theme_mozambique
```

<br/>

```{r sanitation_strata_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "wash" & 
      indicator_label == "Toilet facility" &
      study_round == "Endline" &
      !strata %in% c("Zambézia", "Nampula", "Overall")
  ) |>
  dplyr::mutate(
    province = ifelse(
      strata %in% c("Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"),
      "Nampula", "Zambézia"
    ) |>
      factor(levels = c("Zambézia", "Nampula")),
    strata = factor(
      strata, 
      levels = c(
        "Gurúè", "Lugela", "Pebane", "Molumbo", "Rest of Zambézia", 
        "Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"
      ),
      labels = c(
        "\nGurúè", "\nLugela", "\nPebane", "\nMolumbo", "Rest of\nZambézia", 
        "\nMonapo", "\nNacala-A-Velha", "\nRibáuè", "Rest of\nNampula"
      )
    ),
    indicator_category = factor(
      x = indicator_category,
      levels = c("Open defecation", "Unimproved", "Limited", "Basic")
    )
  ) |>
  ggplot(mapping = aes(x = strata, y = estimate, fill = indicator_category)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(name = "", values = alpha(rev(sanitation_ladder), 0.6)) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Sanitation service ladder",
    subtitle = "Proportion of households in districts of Zambézia and Nampula by type of sanitation facility",
    x = "", y = "%"
  ) +
  facet_wrap(~province, ncol = 2, scales = "free_x") +
  theme_mozambique
```

<br/>

```{r sanitation, echo = FALSE}
sanitation_province_overall <- endline_wash_province_table |>
  subset(
    indicator_label == "Toilet facility",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )()

sanitation_strata <- endline_wash_strata_table |>
  subset(
    indicator_label == "Toilet facility" &
      strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

sanitation_study_group <- endline_wash_study_group_table |>
  subset(
    indicator_label == "Toilet facility" &
      study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  water_province_overall,
  water_strata,
  water_study_group
) |>
  (\(x) x[ , c(1, 2, 6, 10, 3, 7, 11, 4, 8, 12, 5, 9, 13)])() |>
  (\(x)
    {
      x[ , 2:13] <- round(x[ , 2:13] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 4)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Open defecation" = 3, 
      "Unimproved" = 3, 
      "Limited" = 3, 
      "Basic" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

```{r good_toilet_facility, echo = FALSE}
sanitation_subset_province_overall <- endline_wash_subset_province_table |>
  subset(
    indicator_category == "Good toilet facility",
    select = c(indicator_label, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )()

sanitation_subset_strata <- endline_wash_subset_strata_table |>
  subset(
    indicator_category == "Good toilet facility" & strata != "Overall",
    select = c(indicator_label, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

sanitation_subset_study_group <- endline_wash_subset_study_group_table |>
  subset(
    indicator_category == "Good toilet facility" & study_group != "Overall",
    select = c(indicator_label, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  sanitation_subset_province_overall,
  sanitation_subset_strata,
  sanitation_subset_study_group
) |>
  (\(x)
    {
      x[ , 2:4] <- round(x[ , 2:4] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", c("Estimate", "95% LCL", "95% UCL")),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = FALSE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Good toilet facility" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

### Hygiene

```{r hygiene_province_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "wash" & 
      indicator_label == "Handwashing facility" &
      study_round == "Endline" &
      strata %in% c("Zambézia", "Nampula", "Overall")
  ) |>
  dplyr::mutate(
    strata = factor(strata, levels = c("Zambézia", "Nampula", "Overall")),
    indicator_category = factor(
      x = indicator_category,
      levels = c("No facility", "Limited", "Basic")
    )
  ) |>
  ggplot(mapping = aes(x = study_group, y = estimate, fill = indicator_category)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(name = "", values = alpha(rev(hygiene_ladder), 0.6)) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Hygiene service ladder",
    subtitle = "Proportion of households in Zambézia and Nampula by type of handwashing facility",
    x = "", y = "%"
  ) +
  facet_wrap(~strata) +
  theme_mozambique
```

<br/>

```{r hygiene_strata_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "wash" & 
      indicator_label == "Handwashing facility" &
      study_round == "Endline" &
      !strata %in% c("Zambézia", "Nampula", "Overall")
  ) |>
  dplyr::mutate(
    province = ifelse(
      strata %in% c("Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"),
      "Nampula", "Zambézia"
    ) |>
      factor(levels = c("Zambézia", "Nampula")),
    strata = factor(
      strata, 
      levels = c(
        "Gurúè", "Lugela", "Pebane", "Molumbo", "Rest of Zambézia", 
        "Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"
      ),
      labels = c(
        "\nGurúè", "\nLugela", "\nPebane", "\nMolumbo", "Rest of\nZambézia", 
        "\nMonapo", "\nNacala-A-Velha", "\nRibáuè", "Rest of\nNampula"
      )
    ),
    indicator_category = factor(
      x = indicator_category,
      levels = c("No facility", "Limited", "Basic")
    )
  ) |>
  ggplot(mapping = aes(x = strata, y = estimate, fill = indicator_category)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(name = "", values = alpha(rev(hygiene_ladder), 0.6)) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Hygiene service ladder",
    subtitle = "Proportion of households in districts of Zambézia and Nampula by type of handwashing facility",
    x = "", y = "%"
  ) +
  facet_wrap(~province, ncol = 2, scales = "free_x") +
  theme_mozambique
```

<br/>

```{r hygiene, echo = FALSE}
hygiene_province_overall <- endline_wash_province_table |>
  subset(
    indicator_label == "Handwashing facility",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )()

hygiene_strata <- endline_wash_strata_table |>
  subset(
    indicator_label == "Handwashing facility" &
      strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

hygiene_study_group <- endline_wash_study_group_table |>
  subset(
    indicator_label == "Handwashing facility" &
      study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  hygiene_province_overall,
  hygiene_strata,
  hygiene_study_group
) |>
  (\(x) x[ , c(1, 2, 5, 8, 3, 6, 9, 4, 7, 10)])() |>
  (\(x)
    {
      x[ , 2:10] <- round(x[ , 2:10] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "No facility" = 3, 
      "Limited" = 3, 
      "Basic" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

```{r good_handwashing_facility, echo = FALSE}
hygiene_subset_province_overall <- endline_wash_province_table |>
  subset(
    indicator_variable == "basic_handwashing_facility",
    select = c(indicator_label, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )()

hygiene_subset_strata <- endline_wash_strata_table |>
  subset(
    indicator_variable == "basic_handwashing_facility" & strata != "Overall",
    select = c(indicator_label, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

hygiene_subset_study_group <- endline_wash_study_group_table |>
  subset(
    indicator_variable == "basic_handwashing_facility" & study_group != "Overall",
    select = c(indicator_label, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  hygiene_subset_province_overall,
  hygiene_subset_strata,
  hygiene_subset_study_group
) |>
  (\(x)
    {
      x[ , 2:4] <- round(x[ , 2:4] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", c("Estimate", "95% LCL", "95% UCL")),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = FALSE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Good handwashing facility" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

<br/>

## Observations

### By province and overall

```{r observation, echo = FALSE}
endline_observation_province_table_report |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Cleanliness" = 1,
      "Water storage" = 4,
      "Hygienic storage systems" = 4
    )
  )
```

### By study group and overall

```{r observation_study_group, echo = FALSE}
endline_observation_study_group_table_report |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Cleanliness" = 1,
      "Water storage" = 4,
      "Hygienic storage systems" = 4
    )
  )
```

<br/>

## Pica

### By province and overall

```{r pica, echo = FALSE}
endline_pica_province_table_report |>
  subset(
    #indicator_label %in% c("Pica frequency", "Cleaning of child who eats dirt"),
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Pica frequency" = 5,
      "Cleaning of child who eats dirt" = 5,
      "Attitude about pica" = 1
    )
  )
```

### By study group and overall

```{r pica_study_group, echo = FALSE}
endline_pica_study_group_table_report |>
  subset(
    #indicator_label %in% c("Pica frequency", "Cleaning of child who eats dirt"),
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Pica frequency" = 5,
      "Cleaning of child who eats dirt" = 5,
      "Attitude about pica" = 1
    )
  )
```

<br/>

## Vitamin A supplementation and deworming

```{r vita, echo = FALSE}
vita_province_overall <- rbind(
  endline_child_vita_province_table,
  endline_deworming_province_table
) |>
  subset(select = c(indicator_label, strata, estimate, lcl, ucl)) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )()

vita_strata <- rbind(
  endline_child_vita_strata_table,
  endline_deworming_strata_table
) |>
  subset(
    strata != "Overall",
    select = c(indicator_label, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

vita_study_group <- rbind(
  endline_child_vita_study_group_table,
  endline_deworming_study_group_table
) |>
  subset(
    study_group != "Overall",
    select = c(indicator_label, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  vita_province_overall,
  vita_strata,
  vita_study_group
) |>
  (\(x) x[ , c(1, 2, 4, 6, 3, 5, 7)])() |>
  (\(x)
    {
      x[ , 2:7] <- round(x[ , 2:7] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 2)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Vitamin A supplementation" = 3, 
      "Deworming" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

<br/>

## Childhoood immunisation

### Immunisation card retention

```{r immunisation_card, echo = FALSE}
card_province_overall <- rbind(
  endline_child_immunisation_card_self_report_province_table,
  endline_child_immunisation_card_available_province_table
) |>
  subset(select = c(indicator_category, strata, estimate, lcl, ucl)) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )() 

card_strata <- rbind(
  endline_child_immunisation_card_self_report_strata_table,
  endline_child_immunisation_card_available_strata_table
) |>
  subset(
    strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

card_study_group <- rbind(
  endline_child_immunisation_card_self_report_study_group_table,
  endline_child_immunisation_card_available_study_group_table
) |>
  subset(
    study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  card_province_overall,
  card_strata,
  card_study_group
) |>
  (\(x) x[ , c(1, 2, 4, 6, 3, 5, 7)])() |>
  (\(x)
    {
      x[ , 2:7] <- round(x[ , 2:7] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 2)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = FALSE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Has immunisation card (self-report)" = 3, 
      "Immunisaiton card available" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

### Bacillus Calmette–Guérin vaccine

```{r bcg, echo = FALSE}
bcg_province_overall <- endline_child_immunisation_bcg_province_table |>
  subset(select = c(indicator_label, strata, estimate, lcl, ucl)) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )() 

bcg_strata <- endline_child_immunisation_bcg_strata_table |>
  subset(
    strata != "Overall",
    select = c(indicator_label, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

bcg_study_group <- endline_child_immunisation_bcg_study_group_table |>
  subset(
    study_group != "Overall",
    select = c(indicator_label, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  bcg_province_overall,
  bcg_strata,
  bcg_study_group
) |>
  (\(x)
    {
      x[ , 2:4] <- round(x[ , 2:4] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", "Estimate", "95% LCL", "95% UCL"),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = FALSE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "BCG vaccination" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

### Oral polio vaccine

```{r opv, echo = FALSE}
opv_province_overall <- rbind(
  endline_child_immunisation_opv_province_table,
  endline_child_immunisation_set1_province_table,
  endline_child_immunisation_set2_province_table,
  endline_child_immunisation_set3_province_table
) |>
  subset(
    indicator_label == "Polio",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )() 

opv_strata <- rbind(
  endline_child_immunisation_opv_strata_table,
  endline_child_immunisation_set1_strata_table,
  endline_child_immunisation_set2_strata_table,
  endline_child_immunisation_set3_strata_table
) |>
  subset(
    indicator_label == "Polio" & strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

opv_study_group <- rbind(
  endline_child_immunisation_opv_study_group_table,
  endline_child_immunisation_set1_study_group_table,
  endline_child_immunisation_set2_study_group_table,
  endline_child_immunisation_set3_study_group_table
) |>
  subset(
    indicator_label == "Polio" & study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  opv_province_overall,
  opv_strata,
  opv_study_group
) |>
  (\(x) x[ , c(1, 2, 6, 10, 3, 7, 11, 4, 8, 12, 5, 9, 13)])() |>
  (\(x)
    {
      x[ , 2:13] <- round(x[ , 2:13] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 4)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "OPV first dose" = 3, 
      "OPV second dose" = 3,
      "OPV third dose" = 3,
      "OPV fourth dose" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

### Pentavalent vaccine

```{r penta, echo = FALSE}
penta_province_overall <- rbind(
  endline_child_immunisation_set1_province_table,
  endline_child_immunisation_set2_province_table,
  endline_child_immunisation_set3_province_table
) |>
  subset(
    indicator_label == "Pentavalent",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )() 

penta_strata <- rbind(
  endline_child_immunisation_set1_strata_table,
  endline_child_immunisation_set2_strata_table,
  endline_child_immunisation_set3_strata_table
) |>
  subset(
    indicator_label == "Pentavalent" & strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

penta_study_group <- rbind(
  endline_child_immunisation_set1_study_group_table,
  endline_child_immunisation_set2_study_group_table,
  endline_child_immunisation_set3_study_group_table
) |>
  subset(
    indicator_label == "Pentavalent" & study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  penta_province_overall,
  penta_strata,
  penta_study_group
) |>
  (\(x) x[ , c(1, 2, 5, 8, 3, 6, 9, 4, 7, 10)])() |>
  (\(x)
    {
      x[ , 2:10] <- round(x[ , 2:10] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Pentavalent vaccine first dose" = 3, 
      "Pentavalent vaccine second dose" = 3,
      "Pentavalent vaccine third dose" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

### Pneumococcal vaccine

```{r pneumo, echo = FALSE}
pneumo_province_overall <- rbind(
  endline_child_immunisation_set1_province_table,
  endline_child_immunisation_set2_province_table,
  endline_child_immunisation_set3_province_table
) |>
  subset(
    indicator_label == "Pneumococcal",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )() 

pneumo_strata <- rbind(
  endline_child_immunisation_set1_strata_table,
  endline_child_immunisation_set2_strata_table,
  endline_child_immunisation_set3_strata_table
) |>
  subset(
    indicator_label == "Pneumococcal" & strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

pneumo_study_group <- rbind(
  endline_child_immunisation_set1_study_group_table,
  endline_child_immunisation_set2_study_group_table,
  endline_child_immunisation_set3_study_group_table
) |>
  subset(
    indicator_label == "Pneumococcal" & study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  pneumo_province_overall,
  pneumo_strata,
  pneumo_study_group
) |>
  (\(x) x[ , c(1, 2, 5, 8, 3, 6, 9, 4, 7, 10)])() |>
  (\(x)
    {
      x[ , 2:10] <- round(x[ , 2:10] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Pneumococcal vaccine first dose" = 3, 
      "Pneumococcal vaccine second dose" = 3,
      "Pneumococcal vaccine third dose" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

### Rotavirus vaccine

```{r rotavirus, echo = FALSE}
rota_province_overall <- rbind(
  endline_child_immunisation_set1_province_table,
  endline_child_immunisation_set2_province_table,
  endline_child_immunisation_set3_province_table
) |>
  subset(
    indicator_label == "Rotavirus",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )() 

rota_strata <- rbind(
  endline_child_immunisation_set1_strata_table,
  endline_child_immunisation_set2_strata_table,
  endline_child_immunisation_set3_strata_table
) |>
  subset(
    indicator_label == "Rotavirus" & strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

rota_study_group <- rbind(
  endline_child_immunisation_set1_study_group_table,
  endline_child_immunisation_set2_study_group_table,
  endline_child_immunisation_set3_study_group_table
) |>
  subset(
    indicator_label == "Rotavirus" & study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  rota_province_overall,
  rota_strata,
  rota_study_group
) |>
  (\(x) x[ , c(1, 2, 4, 6, 3, 5, 7)])() |>
  (\(x)
    {
      x[ , 2:7] <- round(x[ , 2:7] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 2)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = FALSE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Rotavirus vaccine first dose" = 3, 
      "Rotavirus vaccine second dose" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

### Measles vaccine

```{r measles, echo = FALSE}
measles_province_overall <- endline_child_immunisation_measles_province_table |>
  subset(select = c(indicator_category, strata, estimate, lcl, ucl)) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )() 

measles_strata <- endline_child_immunisation_measles_strata_table |>
  subset(
    strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

measles_study_group <- endline_child_immunisation_measles_study_group_table |>
  subset(
    study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  measles_province_overall,
  measles_strata,
  measles_study_group
) |>
  (\(x) x[ , c(1, 2, 4, 6, 3, 5, 7)])() |>
  (\(x)
    {
      x[ , 2:7] <- round(x[ , 2:7] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 2)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = FALSE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Measles vaccine first dose" = 3, 
      "Measles vaccine second dose" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

### Full immunisation

```{r full_immunisation, echo = FALSE}
full_province_overall <- rbind(
  endline_child_immunisation_full_province_table,
  endline_child_immunisation_age_appropriate_province_table
) |>
  subset(select = c(indicator_category, strata, estimate, lcl, ucl)) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )() 

full_strata <- rbind(
  endline_child_immunisation_full_strata_table,
  endline_child_immunisation_age_appropriate_strata_table
) |>
  subset(
    strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

full_study_group <- rbind(
  endline_child_immunisation_full_study_group_table,
  endline_child_immunisation_age_appropriate_study_group_table
) |>
  subset(
    study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  full_province_overall,
  full_strata,
  full_study_group
) |>
  (\(x) x[ , c(1, 2, 4, 6, 3, 5, 7)])() |>
  (\(x)
    {
      x[ , 2:7] <- round(x[ , 2:7] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 2)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = FALSE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Full immunisation (12-23 months old)" = 3, 
      "Full immunisation (age-appropriate)" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

<br/>

## Childhood development

### By province and overall

```{r child_dev, echo = FALSE}
endline_child_dev_province_table_report |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  (\(x) x[c(2, 6, 7, 1, 4, 5, 3, 8:14), ])() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Walking" = 1,
      "Object identification" = 2,
      "Singing and storytelling" = 3, 
      "Playtime" = 8
    )
  )
```

### By study group and overall

```{r child_dev_study_group, echo = FALSE}
endline_child_dev_study_group_table_report |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  (\(x) x[c(2, 6, 7, 1, 4, 5, 3, 8:14), ])() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Walking" = 1,
      "Object identification" = 2,
      "Singing and storytelling" = 3, 
      "Playtime" = 8
    )
  )
```

<br/>

## Pregnancy

### By province and overall

```{r pregnant, echo = FALSE}
rbind(
  endline_pregnant_card_province_table_report,
  endline_pregnant_card_available_province_table_report,
  endline_pregnant_province_table_report
) |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
    (\(x)
    {
      rbind(
        x[1:2, ],
        x[1, ] |>
          (\(x) 
            { 
              x[1, ] <- c("Mean", rep(NA_character_, 9))
              x 
            }
          )()
      ) |>
        rbind(
          x[3:nrow(x), ]
        )
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Prenatal card" = 2,
      "Gestational age in weeks (self-reported)" = 1,
      "Pregnancy condition" = 2,
      "Diet during pregnancy" = 2,
      "Plans after pregnancy" = 1,
      "Pregnancy danger signs" = 9,
      "Plans when labour begins" = 7
    )
  )
```

### By study group and overall

```{r pregnant_study_group, echo = FALSE}
rbind(
  endline_pregnant_card_study_group_table_report,
  endline_pregnant_card_available_study_group_table_report,
  endline_pregnant_study_group_table_report
) |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  (\(x)
    {
      rbind(
        x[1:2, ],
        x[1, ] |>
          (\(x) 
            { 
              x[1, ] <- c("Mean", rep(NA_character_, 9))
              x 
            }
          )()
      ) |>
        rbind(
          x[3:nrow(x), ]
        )
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Prenatal card" = 2,
      "Gestational age in weeks (self-reported)" = 1,
      "Pregnancy condition" = 2,
      "Diet during pregnancy" = 2,
      "Plans after pregnancy" = 1,
      "Pregnancy danger signs" = 9,
      "Plans when labour begins" = 7
    )
  )
```

<br/>

## PMTCT and malaria prevention

### By province and overall

```{r preg_prevention, echo = FALSE}
rbind(
  endline_pregnant_vct1_province_table_report,
  endline_pregnant_vct2_province_table_report,
  endline_pregnant_vct3_province_table_report,
  endline_pregnant_prevention_province_table_report
) |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Prevention of mother-to-child transmission" = 3,
      "Malaria prevention" = 2
    )
  )
```

### By study group and overall

```{r preg_prevention_study_group, echo = FALSE}
rbind(
  endline_pregnant_vct1_study_group_table_report,
  endline_pregnant_vct2_study_group_table_report,
  endline_pregnant_vct3_study_group_table_report,
  endline_pregnant_prevention_study_group_table_report
) |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Prevention of mother-to-child transmission" = 3,
      "Malaria prevention" = 2
    )
  )
```

<br/>

## Pre- and post-natal care

### By province and overall

```{r natal_care, echo = FALSE}
rbind(
  endline_natal_care_province_table_report,
  endline_natal_care1_province_table_report,
  endline_natal_care_malaria1_province_table_report,
  endline_natal_care_malaria2_province_table_report,
  endline_natal_care_tetanus1_province_table_report,
  endline_natal_care_tetanus2_province_table_report,
  endline_natal_care_supplement_province_table_report
) |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  (\(x)
    {
      rbind(
        x,
        x[1, ] <- c("Received vitamin A tablets", rep(NA_character_, 9))
      ) 
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Location of last delivery" = 7,
      "Number of prenatal visits" = 7,
      "Prenatal care coverage" = 1, 
      "Experience during prenatal care" = 1,
      "Experience during delivery" = 1,
      "Person assisting during delivery" = 9,
      "Difficulties reaching facility" = 6,
      "Time to postnatal check for child" = 5,
      "Time to postnatal check for mother" = 5,
      "Malaria medication during pregnancy" = 3,
      "Tetanus toxoid vaccination during pregnancy" = 2,
      "Ferrous sulfate supplementation" = 1,
      "Vitamin A supplementation" = 1
    )
  )
```

### By study group and overall

```{r natal_care_study_group, echo = FALSE}
rbind(
  endline_natal_care_study_group_table_report,
  endline_natal_care1_study_group_table_report,
  endline_natal_care_malaria1_study_group_table_report,
  endline_natal_care_malaria2_study_group_table_report,
  endline_natal_care_tetanus1_study_group_table_report,
  endline_natal_care_tetanus2_study_group_table_report,
  endline_natal_care_supplement_study_group_table_report
) |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  (\(x)
    {
      rbind(
        x,
        x[1, ] <- c("Received vitamin A tablets", rep(NA_character_, 9))
      ) 
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Location of last delivery" = 7,
      "Number of prenatal visits" = 7,
      "Prenatal care coverage" = 1, 
      "Experience during prenatal care" = 1,
      "Experience during delivery" = 1,
      "Person assisting during delivery" = 9,
      "Difficulties reaching facility" = 6,
      "Time to postnatal check for child" = 5,
      "Time to postnatal check for mother" = 5,
      "Malaria medication during pregnancy" = 3,
      "Tetanus toxoid vaccination during pregnancy" = 2,
      "Ferrous sulfate supplementation" = 1,
      "Vitamin A supplementation" = 1
    )
  )
```

<br/>

## Family planning

### By province and overall

```{r family_planning, echo = FALSE}
endline_family_planning_province_table_report |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Use of family planning methods" = 1,
      "Benefit of waiting for next pregnancy" = 6,
      "Benefit of waiting until 18 years of age before getting pregnant" = 6, 
      "Problem with having more than 4 children" = 6
    )
  )
```

### By study group and overall

```{r family_planning_study_group, echo = FALSE}
endline_family_planning_study_group_table_report |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Use of family planning methods" = 1,
      "Benefit of waiting for next pregnancy" = 6,
      "Benefit of waiting until 18 years of age before getting pregnant" = 6, 
      "Problem with having more than 4 children" = 6
    )
  )
```

<br/>

## Women's anthropometry

```{r women_anthro_province_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "women_anthro" &
      indicator_category != "Mean" &
      study_round == "Endline" &
      strata %in% c("Zambézia", "Nampula", "Overall")
  ) |>
  dplyr::mutate(
    strata = factor(strata, levels = c("Zambézia", "Nampula", "Overall")),
    indicator_category = factor(
      x = indicator_category,
      levels = c("Obese", "Overweight", "Healthy weight", "Underweight")
    )
  ) |>
  ggplot(mapping = aes(x = study_group, y = estimate * 100, fill = indicator_category)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(name = "", values = alpha(bmi_classes, 0.6)) +
  labs(
    title = "Women's nutrition status",
    subtitle = "Proportion of women of reproductive age in Zambézia and Nampula by nutrition status based on body mass index",
    x = "", y = "%"
  ) +
  facet_wrap(~strata, ncol = 3) +
  theme_mozambique
```

<br/>

```{r women_anthro_strata_plot, fig.align = "center", fig.width = 10}
overall_results_all |>
  subset(
    indicator_set_code == "women_anthro" &
      indicator_category != "Mean" &
      study_round == "Endline" &
      !strata %in% c("Zambézia", "Nampula", "Overall")
  ) |>
  dplyr::mutate(
    province = ifelse(
      strata %in% c("Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"),
      "Nampula", "Zambézia"
    ) |>
      factor(levels = c("Zambézia", "Nampula")),
    strata = factor(
      strata, 
      levels = c(
        "Gurúè", "Lugela", "Pebane", "Molumbo", "Rest of Zambézia", 
        "Monapo", "Nacala-A-Velha", "Ribáuè", "Rest of Nampula"
      ),
      labels = c(
        "\nGurúè", "\nLugela", "\nPebane", "\nMolumbo", "Rest of\nZambézia", 
        "\nMonapo", "\nNacala-A-Velha", "\nRibáuè", "Rest of\nNampula"
      )
    ),
    indicator_category = factor(
      x = indicator_category,
      levels = c("Obese", "Overweight", "Healthy weight", "Underweight")
    )
  ) |>
  ggplot(mapping = aes(x = strata, y = estimate * 100, fill = indicator_category)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(name = "", values = alpha(bmi_classes, 0.6)) +
  labs(
    title = "Women's nutrition status",
    subtitle = "Proportion of households in districts of Zambézia and Nampula by nutrition status based on body mass index",
    x = "", y = "%"
  ) +
  facet_wrap(~province, ncol = 2, scales = "free_x") +
  theme_mozambique
```

<br/>

```{r women_anthro, echo = FALSE}
bmi_province_overall <- endline_women_anthro_province_table |>
  subset(
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )()

bmi_strata <- endline_women_anthro_strata_table |>
  subset(
    strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )
bmi_study_group <- endline_women_anthro_study_group_table |>
  subset(
    study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  bmi_province_overall,
  bmi_strata,
  bmi_study_group
) |>
  (\(x) x[ , c(1, 2, 7, 12, 3, 8, 13, 4, 9, 14, 5, 10, 15, 6, 11, 16)])() |>
  (\(x)
    {
      x[ , 2:4]  <- round(x[ , 2:4], digits = 1)
      x[ , 5:16] <- round(x[ , 5:16] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 5)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Mean BMI" = 3, 
      "Underweight" = 3, 
      "Healthy weight" = 3, 
      "Overweight" = 3,
      "Obese" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

<br/>

## Women's dietary diversity score

### Food groups by province and overall

```{r wdds, echo = FALSE}
endline_wdds_province_table_report |>
  subset(
    indicator_label == "WDDS food group",
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "WDDS food group" = 9
    )
  )
```

### Food groups by study group and overall

```{r wdds_study_group, echo = FALSE}
endline_wdds_study_group_table_report |>
  subset(
    indicator_label == "WDDS food group",
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "WDDS food group" = 9
    )
  )
```

### Mean women's dietary diversity score

```{r wdds_strata, echo = FALSE}
wdds_province_overall <- endline_wdds_province_table |>
  subset(
    indicator_label == "Women's Dietary Diversity Score (WDDS)",
    select = c(indicator_label, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )() 

wdds_strata <- endline_wdds_strata_table |>
  subset(
    indicator_label == "Women's Dietary Diversity Score (WDDS)" &
      strata != "Overall",
    select = c(indicator_label, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

wdds_study_group <- endline_wdds_study_group_table |>
  subset(
    indicator_label == "Women's Dietary Diversity Score (WDDS)" &
      study_group != "Overall",
    select = c(indicator_label, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  wdds_province_overall,
  wdds_strata,
  wdds_study_group
) |>
  (\(x)
    {
      x[ , 2:4] <- round(x[ , 2:4], digits = 3)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", "Estimate", "95% LCL", "95% UCL"),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = FALSE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Mean WDDS" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

<br/>

## Minimum dietary diversity for women

### Food groups by province and overall

```{r mddw, echo = FALSE}
endline_mddw_province_table_report |>
  subset(
    indicator_label == "MDD-W food group",
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "MDD-W food group" = 10
    )
  )
```

### Food groups by study group and overall

```{r mddw_study_group, echo = FALSE}
endline_mddw_study_group_table_report |>
  subset(
    indicator_label == "MDD-W food group",
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "MDD-W food group" = 10
    )
  )
```

### Minimum dietary diversity for women

```{r mddw_strata, echo = FALSE}
mddw_province_overall <- endline_mddw_province_table |>
  subset(
    indicator_label != "MDD-W food group",
    select = c(indicator_label, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )() 

mddw_strata <- endline_mddw_strata_table |>
  subset(
    indicator_label != "MDD-W food group" &
      strata != "Overall",
    select = c(indicator_label, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

mddw_study_group <- endline_mddw_study_group_table |>
  subset(
    indicator_label != "MDD-W food group" &
      study_group != "Overall",
    select = c(indicator_label, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_label,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  mddw_province_overall,
  mddw_strata,
  mddw_study_group
) |>
  (\(x) x[ , c(1, 2, 4, 6, 3, 5, 7)])() |>
  (\(x)
    {
      x[ , 2:4] <- round(x[ , 2:4], digits = 3)
      x[ , 5:7] <- round(x[ , 5:7] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 2)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = FALSE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Mean MDD-W food group score" = 3,
      "MDD-W" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

<br/>

## Women's decision making

### By province and overall

```{r wem, echo = FALSE}
endline_wem_province_table_report |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Freedom of choice" = 6,
      "Control over destiny" = 6,
      "Make decision without husband" = 6, 
      "Willingly participated in survey" = 6
    )
  )
```

### By study group and overall

```{r wem_study_group, echo = FALSE}
endline_wem_study_group_table_report |>
  subset(
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Freedom of choice" = 6,
      "Control over destiny" = 6,
      "Make decision without husband" = 6, 
      "Willingly participated in survey" = 6
    )
  )
```

<br/>

## Women's mental health

```{r phq8, echo = FALSE}
phq8_province_overall <- endline_women_phq8_province_table |>
  subset(
    indicator_label != "Alcohol consumption",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x)
   {
     rbind(
       x[3, ],
       x[1:2, ]
     )
   }
  )() 

phq8_strata <- endline_women_phq8_strata_table |>
  subset(
    indicator_label != "Alcohol consumption" &
      strata != "Overall",
    select = c(indicator_category, strata, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  )

phq8_study_group <- endline_women_phq8_study_group_table |>
  subset(
    indicator_label != "Alcohol consumption" &
      study_group != "Overall",
    select = c(indicator_category, study_group, estimate, lcl, ucl)
  ) |>
  tidyr::pivot_wider(
    names_from = indicator_category,
    values_from = c(estimate, lcl, ucl),
    names_sep = "_"
  ) |>
  (\(x) { names(x)[1] <- "strata"; x })()

rbind(
  phq8_province_overall,
  phq8_strata,
  phq8_study_group
) |>
  (\(x) x[ , c(1, 2, 6, 10, 3, 7, 11, 4, 8, 12, 5, 9, 13)])() |>
  (\(x)
    {
      x[ , 2:4] <- round(x[ , 2:4], digits = 3)
      x[ , 5:13] <- round(x[ , 5:13] * 100, digits = 1)
      x
    }
  )() |>
  knitr::kable(
    row.names = FALSE,
    col.names = c(" ", rep(c("Estimate", "95% LCL", "95% UCL"), 4)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = FALSE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(
      " " = 1, 
      "Mean PHQ8 score" = 3,
      "Major depression" = 3,
      "Severe depression" = 3,
      "At least major depression" = 3
    ),
    bold = TRUE
  ) |>
  kableExtra::pack_rows(
    index = c(
      "Overall" = 1,
      "Province" = 2,
      "Districts in Zambezia" = 5, 
      "Districts in Nampula" = 4, 
      "Study group" = 2
    )
  )
```

<br/>

## Women's alcohol consumption

### By province and overall

```{r alcohol, echo = FALSE}
endline_women_phq8_province_table_report |>
  subset(
    indicator_label == "Alcohol consumption",
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -study_group
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Zambezia" = 3, "Nampula" = 3, "Overall" = 3),
    bold = TRUE
  )
```

### By study group and overall

```{r alcohol_study_group, echo = FALSE}
endline_women_phq8_study_group_table_report |>
  subset(
    indicator_label == "Alcohol consumption",
    select = c(
      -indicator_label, -indicator_set, -indicator, 
      -study_round, -strata
    )
  ) |>
  knitr::kable(
    row.names = FALSE,
    col.names = c("Variable", rep(c("Estimate", "95% LCL", "95% UCL"), 3)),
    align = "r"
  ) |>
  kableExtra::kable_paper(
    lightable_options = "striped", full_width = TRUE, font_size = 12
  ) |>
  kableExtra::add_header_above(
    header = c(" " = 1, "Comparison" = 3, "Intervention" = 3, "Overall" = 3),
    bold = TRUE
  )
```


<br/>
<br/>
